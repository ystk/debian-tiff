Description: fix denial of service via invalid td_stripbytecount field
Origin: upstream, r1.24.2.7, r1.14.2.5
Bug: http://bugzilla.maptools.org/show_bug.cgi?id=1996
Bug-Ubuntu: https://bugs.launchpad.net/bugs/597246

Index: tiff-3.9.4/libtiff/tif_ojpeg.c
===================================================================
--- tiff-3.9.4.orig/libtiff/tif_ojpeg.c	2011-03-03 10:40:33.000000000 -0500
+++ tiff-3.9.4/libtiff/tif_ojpeg.c	2011-03-03 10:41:33.000000000 -0500
@@ -1918,8 +1918,14 @@
 					{
 						if (sp->in_buffer_file_pos>=sp->file_size)
 							sp->in_buffer_file_pos=0;
+						else if (sp->tif->tif_dir.td_stripbytecount==NULL)
+							sp->in_buffer_file_togo=sp->file_size-sp->in_buffer_file_pos;
 						else
 						{
+							if (sp->tif->tif_dir.td_stripbytecount == 0) {
+								TIFFErrorExt(sp->tif->tif_clientdata,sp->tif->tif_name,"Strip byte counts are missing");
+								return(0);
+							}
 							sp->in_buffer_file_togo=sp->tif->tif_dir.td_stripbytecount[sp->in_buffer_next_strile];  
 							if (sp->in_buffer_file_togo==0)
 								sp->in_buffer_file_pos=0;
Index: tiff-3.9.4/tools/tiffsplit.c
===================================================================
--- tiff-3.9.4.orig/tools/tiffsplit.c	2011-03-03 10:41:02.000000000 -0500
+++ tiff-3.9.4/tools/tiffsplit.c	2011-03-03 10:41:36.000000000 -0500
@@ -237,7 +237,10 @@
 		tstrip_t s, ns = TIFFNumberOfStrips(in);
 		uint32 *bytecounts;
 
-		TIFFGetField(in, TIFFTAG_STRIPBYTECOUNTS, &bytecounts);
+		if (!TIFFGetField(in, TIFFTAG_STRIPBYTECOUNTS, &bytecounts)) {
+			fprintf(stderr, "tiffsplit: strip byte counts are missing\n");
+			return (0);
+		}
 		for (s = 0; s < ns; s++) {
 			if (bytecounts[s] > (uint32)bufsize) {
 				buf = (unsigned char *)_TIFFrealloc(buf, bytecounts[s]);
@@ -267,7 +270,10 @@
 		ttile_t t, nt = TIFFNumberOfTiles(in);
 		uint32 *bytecounts;
 
-		TIFFGetField(in, TIFFTAG_TILEBYTECOUNTS, &bytecounts);
+		if (!TIFFGetField(in, TIFFTAG_TILEBYTECOUNTS, &bytecounts)) {
+			fprintf(stderr, "tiffsplit: tile byte counts are missing\n");
+			return (0);
+		}
 		for (t = 0; t < nt; t++) {
 			if (bytecounts[t] > (uint32) bufsize) {
 				buf = (unsigned char *)_TIFFrealloc(buf, bytecounts[t]);
